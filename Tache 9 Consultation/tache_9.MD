# T√¢che OR-372 ‚Äî Lister toutes les demandes OR (Admin DSI)

## Objectif

Permettre √† un utilisateur disposant du r√¥le `ADMIN_DSI` de consulter **toutes les demandes d‚ÄôOrdres de R√©exp√©dition (OR)** dans le syst√®me, sans restriction par utilisateur.
L‚Äôobjectif est de fournir une **vue globale** pour la supervision et le suivi des r√©exp√©ditions.

---

## Compr√©hension du besoin

Cette t√¢che vise √† cr√©er :

* une **route s√©curis√©e c√¥t√© backend** pour exposer toutes les demandes OR,
* une **page Angular** affichant ces donn√©es,
* et un **lien d‚Äôacc√®s r√©serv√© aux DSI** dans le menu d‚Äôadministration.

---

## Architecture globale

| Couche   | √âl√©ment ajout√©                      | R√¥le                                                   |
| -------- | ----------------------------------- | ------------------------------------------------------ |
| Backend  | `OrAdminResource` (REST Controller) | Expose la liste compl√®te des demandes OR               |
| Backend  | `DemandeOrService.findAll()`        | M√©thode m√©tier pour r√©cup√©rer les donn√©es              |
| Frontend | `ListeOrAdminComponent`             | Affiche la liste des demandes dans l‚ÄôIHM               |
| Frontend | Route `/admin/liste-or`             | Permet d‚Äôacc√©der √† la page                             |
| Frontend | Menu ‚ÄúDemandes OR (Admin)‚Äù          | Lien de navigation visible uniquement pour `ADMIN_DSI` |

---

## BACKEND ‚Äî Spring Boot

### Service m√©tier

Fichier : `src/main/java/nc/opt/sior/service/DemandeOrService.java`

```java
package nc.opt.sior.service;

import lombok.extern.slf4j.Slf4j;
import nc.opt.sior.domain.DemandeOr;
import nc.opt.sior.repository.DemandeOrRepository;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

@Slf4j
@Service
@Transactional
public class DemandeOrService {

    private final DemandeOrRepository demandeOrRepository;

    public DemandeOrService(DemandeOrRepository demandeOrRepository) {
        this.demandeOrRepository = demandeOrRepository;
    }

    /**
     * R√©cup√®re toutes les Demandes OR.
     */
    @Transactional(readOnly = true)
    public List<DemandeOr> findAll() {
        log.debug("üì¶ R√©cup√©ration de toutes les demandes OR (ADMIN_DSI)");
        return demandeOrRepository.findAll();
    }
}
```

**Explications :**

* `@Transactional(readOnly = true)` : optimisation pour les lectures.
* `findAll()` appelle directement le `JpaRepository` pour lister toutes les entit√©s `DemandeOr`.
* Pas de filtrage par utilisateur : le DSI voit toutes les demandes.

---

### Contr√¥leur REST s√©curis√©

Fichier : `src/main/java/nc/opt/sior/web/rest/OrAdminResource.java`

```java
package nc.opt.sior.web.rest;

import lombok.extern.slf4j.Slf4j;
import nc.opt.sior.domain.DemandeOr;
import nc.opt.sior.service.DemandeOrService;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@Slf4j
@RestController
@RequestMapping("/api/admin")
public class OrAdminResource {

    private final DemandeOrService demandeOrService;

    public OrAdminResource(DemandeOrService demandeOrService) {
        this.demandeOrService = demandeOrService;
    }

    /**
     * GET /or-demandes : R√©cup√®re toutes les demandes OR (ADMIN_DSI uniquement).
     */
    @GetMapping("/or-demandes")
    @PreAuthorize("hasAuthority('ADMIN_DSI')")
    public ResponseEntity<List<DemandeOr>> getAllDemandesOr() {
        log.info("üìã Consultation de toutes les demandes OR par un ADMIN_DSI");
        List<DemandeOr> demandes = demandeOrService.findAll();
        return ResponseEntity.ok(demandes);
    }
}
```

**S√©curit√© :**

* `@PreAuthorize("hasAuthority('ADMIN_DSI')")` :
  emp√™che tout autre r√¥le d‚Äôappeler l‚Äôendpoint.
* Accessible uniquement via `/api/admin/or-demandes`.

---

### Exemple de r√©ponse JSON

```json
[
  {
    "id": 101,
    "statut": "EN_ATTENTE",
    "dateDebut": "2025-10-01T00:00:00Z",
    "dateFin": "2025-10-31T00:00:00Z",
    "lastModifiedDate": "2025-11-02T15:45:21Z"
  },
  {
    "id": 102,
    "statut": "VALID√â",
    "dateDebut": "2025-09-01T00:00:00Z",
    "dateFin": "2025-10-01T00:00:00Z",
    "lastModifiedDate": "2025-11-03T10:15:00Z"
  }
]
```

---

## FRONTEND ‚Äî Angular (JHipster)

### Cr√©ation du composant

Commande utilis√©e :

```bash
ng generate component liste-or-admin
```

Structure cr√©√©e :

```
src/main/webapp/app/liste-or-admin/
 ‚îú‚îÄ‚îÄ liste-or-admin.component.ts
 ‚îú‚îÄ‚îÄ liste-or-admin.component.html
 ‚îú‚îÄ‚îÄ liste-or-admin.component.scss
 ‚îî‚îÄ‚îÄ liste-or-admin.component.spec.ts
```

---

### Logique TypeScript

Fichier : `liste-or-admin.component.ts`

```typescript
import { Component, OnInit } from '@angular/core';
import { HttpClient } from '@angular/common/http';

type AdminRow = { id: number; statut: string; lastModifiedDate: string; };

@Component({
  selector: 'app-liste-or-admin',
  templateUrl: './liste-or-admin.component.html',
})
export class ListeOrAdminComponent implements OnInit {
  data: AdminRow[] = [];

  constructor(private http: HttpClient) {}

  ngOnInit(): void {
    this.http.get<AdminRow[]>('/api/admin/or-demandes').subscribe({
      next: rows => (this.data = rows),
      error: err => console.error('Erreur chargement demandes OR admin', err),
    });
  }
}
```
---

# Explication d√©taill√©e du component TypeScript

## Explication compl√®te (p√©dagogique)

### 1. Le r√¥le du composant

Ce composant :

* contacte le backend
* r√©cup√®re la liste des demandes OR
* les stocke dans `data`
* et laisse Angular afficher le tableau dans le HTML

### 2. Le d√©corateur `@Component`

```ts
@Component({
  selector: 'app-liste-or-admin',
  templateUrl: './liste-or-admin.component.html',
})
```

* `selector`: nom de la balise HTML du composant (utile seulement si on l‚Äôins√®re manuellement)
* `templateUrl`: fichier HTML associ√©

Comme on acc√®de via une route, **le selector n‚Äôest pas utilis√© directement**.

---

### 3. Injection du HttpClient

```ts
constructor(private http: HttpClient) {}
```

Permet d‚Äôappeler les API REST du backend.

JHipster configure automatiquement HttpClient dans l'application.

---

### 4. Appel de l‚ÄôAPI dans `ngOnInit()`

`ngOnInit()` = m√©thode appel√©e quand Angular charge la page.

```ts
ngOnInit(): void {
  this.http.get<AdminRow[]>('/api/admin/or-demandes')
```

Ce `GET` correspond exactement √† l‚Äôendpoint :

```
GET /api/admin/or-demandes
```

---

### 5. Le subscribe()

```ts
.subscribe({
  next: rows => (this.data = rows),
  error: err => console.error(...)
});
```

Angular utilise un syst√®me d‚Äô**Observable** ‚Üí il faut s‚Äôy abonner.

‚úî `next:` ‚Üí la r√©ponse arrive ‚Üí on met les donn√©es dans `this.data`
‚úî `error:` ‚Üí gestion des erreurs

---

### 6. Le r√¥le de `data: AdminRow[] = []`

* `data` est un tableau vide au d√©part
* Quand le backend r√©pond ‚Üí rempli avec les r√©sultats
* Le template utilise `*ngFor="let row of data"`

Angular met automatiquement √† jour le DOM (data-binding)

---




---

### Template HTML

Fichier : `liste-or-admin.component.html`

```html
<div class="container mt-4">
  <h1 class="text-center">Liste des Demandes OR (Admin)</h1>
  <p class="text-muted text-center">Vue de supervision des ordres de r√©exp√©dition</p>

  <table class="table table-striped mt-4" *ngIf="data.length > 0; else empty">
    <thead>
      <tr>
        <th>ID</th>
        <th>Statut</th>
        <th>Derni√®re mise √† jour</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let row of data">
        <td>{{ row.id }}</td>
        <td>{{ row.statut }}</td>
        <td>{{ row.lastModifiedDate | date:'short' }}</td>
      </tr>
    </tbody>
  </table>

  <ng-template #empty>
    <div class="alert alert-info text-center mt-4">Aucune demande OR trouv√©e.</div>
  </ng-template>
</div>
```

**Explications :**

* `*ngFor` : it√®re sur la liste des OR.
* `*ngIf` : affiche le tableau seulement s‚Äôil y a des donn√©es.
* `ng-template #empty` : message d‚Äôabsence de donn√©es.
* `| date:'short'` : formate la date proprement.

---

### Routing Angular

Dans `sior-app-routing.module.ts` :

```typescript
{
  path: 'admin/liste-or',
  component: ListeOrAdminComponent,
  canActivate: [UserRouteAccessService],
  data: { authorities: [Authority.ADMIN_DSI] },
}
```

**S√©curit√© front :**
M√™me logique que le backend ‚Üí le `UserRouteAccessService` emp√™che l‚Äôacc√®s si l‚Äôutilisateur n‚Äôest pas un `ADMIN_DSI`.

---

### Lien dans la barre de navigation

Fichier : `navbar.component.html`

```html
<li>
  <a (click)="collapseNavbar()" class="dropdown-item" routerLink="/admin/liste-or" routerLinkActive="active">
    <fa-icon [fixedWidth]="true" icon="clipboard-list"></fa-icon>
    <span>Demandes OR (Admin)</span>
  </a>
</li>
```

Visible uniquement pour les compte ayant les droits `ADMIN_DSI`.

---
## Concepts Angular abord√©s

| Concept                  | Description                                           |
| ------------------------ | ----------------------------------------------------- |
| `Component`              | Composant Angular = unit√© visuelle + logique associ√©e |
| `OnInit`                 | M√©thode ex√©cut√©e √† l‚Äôinitialisation du composant      |
| `HttpClient`             | Permet d‚Äôappeler les APIs REST du backend             |
| `subscribe()`            | G√®re les Observables asynchrones                      |
| `routerLink`             | Navigation interne sans rechargement                  |
| `UserRouteAccessService` | V√©rifie les r√¥les utilisateurs c√¥t√© front             |
| `Authority.ADMIN_DSI`    | Constante utilis√©e pour le contr√¥le des acc√®s         |

---
## √âtape compl√©mentaire ‚Äî Gestion du i18n et corrections front-end

### Contexte

Apr√®s la mise en place du composant **Liste des Demandes OR (Admin)** et du lien dans le menu d‚Äôadministration,
nous avons ajout√© la **gestion du i18n (internationalisation)** pour rendre la page multilingue
et r√©solu plusieurs erreurs li√©es √† la traduction et au routage Angular.

---

## Internationalisation (i18n)

L‚Äôobjectif est d‚Äôafficher tous les libell√©s et titres de la page via le syst√®me de traduction JHipster
afin de pouvoir facilement g√©rer plusieurs langues (par d√©faut : **fran√ßais** et **anglais**).

### Structure des fichiers i18n

Les traductions sont stock√©es dans les fichiers JSON suivants :

```
src/main/webapp/i18n/
 ‚îú‚îÄ‚îÄ fr/
      ‚îî‚îÄ‚îÄ liste-or-admin.json

```

### Contenu du fichier fran√ßais

`src/main/webapp/i18n/fr/liste-or-admin.json`

```json
{
  "sior": {
    "listeOrAdmin": {
      "title": "Demandes OR (Admin)",
      "subtitle": "Vue de supervision des ordres de r√©exp√©dition",
      "columns": {
        "id": "Num√©ro de demande",
        "statut": "Statut",
        "lastModifiedDate": "Derni√®re mise √† jour"
      },
      "noData": "Aucune demande trouv√©e."
    }
  }
}
```

---

## Int√©gration dans le template Angular

Dans `liste-or-admin.component.html`, nous avons remplac√© le texte statique par les cl√©s i18n :

```html
<div class="container mt-4">
  <h1 class="text-center" jhiTranslate="sior.listeOrAdmin.title">Demandes OR (Admin)</h1>
  <p class="text-muted text-center" jhiTranslate="sior.listeOrAdmin.subtitle">
    Vue de supervision des ordres de r√©exp√©dition
  </p>

  <table class="table table-striped mt-4" *ngIf="data.length > 0; else empty">
    <thead>
      <tr>
        <th jhiTranslate="sior.listeOrAdmin.columns.id">Num√©ro de demande</th>
        <th jhiTranslate="sior.listeOrAdmin.columns.statut">Statut</th>
        <th jhiTranslate="sior.listeOrAdmin.columns.lastModifiedDate">Derni√®re mise √† jour</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let row of data">
        <td>{{ row.id }}</td>
        <td>{{ row.statut }}</td>
        <td>{{ row.lastModifiedDate | date:'short' }}</td>
      </tr>
    </tbody>
  </table>

  <ng-template #empty>
    <div class="alert alert-info text-center mt-4" jhiTranslate="sior.listeOrAdmin.noData">
      Aucune demande OR trouv√©e.
    </div>
  </ng-template>
</div>
```

---

## R√©solution du message `translation-not-found[...]`

Lors des premiers tests, la page affichait :

```
translation-not-found[Demandes OR (Admin)]
```

Cela provenait d‚Äôune mauvaise utilisation de `jhiTranslate`.

### Exemple erron√© :

```html
<h1 jhiTranslate="Demandes OR (Admin)">Demandes OR (Admin)</h1>
```

Ici, Angular cherche une cl√© `"Demandes OR (Admin)"` dans les fichiers JSON (cl√© inexistante).

### Correction :

```html
<h1 jhiTranslate="sior.listeOrAdmin.title">Demandes OR (Admin)</h1>
```

On utilise la **cl√©** d√©finie dans le fichier i18n (`sior.listeOrAdmin.title`).

Le texte entre balises `<h1>...</h1>` reste un **fallback**,
utilis√© uniquement si la traduction ne se charge pas.

---

## V√©rification et bonnes pratiques

### V√©rifier le chargement du fichier i18n

1. Ouvrir la console navigateur (`F12 ‚Üí Network`).
2. Recharger la page.
3. V√©rifier la requ√™te :

   ```
   GET http://localhost:9000/i18n/fr/liste-or-admin.json
   ```

   Doit retourner un code **200 OK**.

### Si la traduction ne s‚Äôapplique pas :

* V√©rifier le nom du fichier (`liste-or-admin.json` en minuscules).
* Relancer le front (`npm start`).
* Vider le cache du navigateur (`Ctrl + F5`).

---

## Concepts Angular/JHipster appliqu√©s

| Concept                    | Description                                                                            |
| -------------------------- | -------------------------------------------------------------------------------------- |
| **`jhiTranslate`**         | Directive fournie par JHipster (bas√©e sur `ngx-translate`) pour g√©rer les traductions. |
| **Fallback text**          | Texte affich√© si la cl√© i18n est introuvable.                                          |
| **Structure hi√©rarchique** | Les cl√©s JSON suivent la logique du module (`sior.listeOrAdmin.*`).                    |

---

## R√©sultat final apr√®s ajout du i18n

* Page `/admin/liste-or` toujours accessible uniquement aux utilisateurs `ADMIN_DSI`.
* Textes enti√®rement traduits via le syst√®me i18n.
* Disparition du message `translation-not-found[...]`.
* Fichiers i18n organis√©s et pr√™ts pour l‚Äôajout d‚Äôautres langues.

---

## Points appris et bonnes pratiques

1. Toujours utiliser une **cl√© de traduction** (et non le texte brut) avec `jhiTranslate`.
2. Nommer les fichiers i18n selon le composant (`liste-or-admin.json`).
3. V√©rifier le **chargement r√©seau** pour d√©tecter les 404 de traduction.
4. Red√©marrer le front (`npm start`) apr√®s ajout d‚Äôun nouveau fichier i18n.
5. Garder une **structure claire et modulaire** (`sior.nomDuComposant`).

---

## R√©sultat final

* Une page `/admin/liste-or` visible uniquement par les administrateurs DSI.
* Affichage clair et filtr√© de toutes les demandes OR.
* Int√©gration compl√®te front‚Äìback.
* Fonctionnalit√© test√©e et compil√©e avec succ√®s via  `./gradlew bootRun`. (Il n'y a plus besoin de passer par npm start.)

---

## Structure finale du projet

```
src/
 ‚îú‚îÄ‚îÄ main/java/nc/opt/sior/
 ‚îÇ    ‚îú‚îÄ‚îÄ domain/DemandeOr.java
 ‚îÇ    ‚îú‚îÄ‚îÄ repository/DemandeOrRepository.java
 ‚îÇ    ‚îú‚îÄ‚îÄ service/DemandeOrService.java
 ‚îÇ    ‚îî‚îÄ‚îÄ web/rest/OrAdminResource.java
 ‚îÇ
 ‚îî‚îÄ‚îÄ main/webapp/app/
      ‚îú‚îÄ‚îÄ liste-or-admin/
      ‚îÇ    ‚îú‚îÄ‚îÄ liste-or-admin.component.ts
      ‚îÇ    ‚îú‚îÄ‚îÄ liste-or-admin.component.html
      ‚îÇ    ‚îî‚îÄ‚îÄ liste-or-admin.component.scss
      ‚îú‚îÄ‚îÄ layouts/navbar/navbar.component.html
      ‚îî‚îÄ‚îÄ sior-app-routing.module.ts
```







