# T√¢che : Impl√©mentation de l‚Äôendpoint POST pour la cr√©ation d‚Äôun OR d√©finitif

## Objectif

Mise en place d‚Äôun **endpoint REST POST `/api/or-definitif`** permettant la cr√©ation d‚Äôun **Ordre de R√©exp√©dition (OR) d√©finitif**.
Les donn√©es re√ßues (payload JSON) sont stock√©es **int√©gralement dans la table `demande_or`** via une colonne `data` de type **JSONB** (PostgreSQL) ou **CLOB** (H2 pour les tests).

---

## D√©tails d‚Äôimpl√©mentation

* **Nouvelle colonne `data`** ajout√©e dans `demande_or` via Liquibase :

  * Type : `jsonb` pour PostgreSQL, `clob` pour H2
  * Contrainte : `nullable = false`

  ```xml
  <changeSet id="20251103-01" author="a.nguyen">
      <addColumn tableName="demande_or" dbms="postgresql">
          <column name="data" type="jsonb">
              <constraints nullable="false"/>
          </column>
      </addColumn>

      <addColumn tableName="demande_or" dbms="h2">
          <column name="data" type="clob">
              <constraints nullable="false"/>
          </column>
      </addColumn>
  </changeSet>
  ```

---

### Entit√© `DemandeOr.java`

Mise √† jour de la structure pour inclure le champ JSON complet de la demande OR :

```java
@Entity
@Table(name = "demande_or")
@Getter
@Setter
public class DemandeOr extends AbstractAuditingEntity implements Serializable {

    @Id
    @GeneratedValue(strategy = GenerationType.SEQUENCE, generator = "sequenceGenerator")
    @SequenceGenerator(name = "sequenceGenerator")
    private Long id;

    @Column(name = "date_debut", nullable = false)
    private Instant dateDebut;

    @Column(name = "date_fin", nullable = false)
    private Instant dateFin;

    @Lob
    @Column(name = "data", nullable = false)
    private String data;
}
```

---

### Service m√©tier `OrDematService.java`

Ajout de la m√©thode de cr√©ation d‚Äôun OR d√©finitif.
Le payload JSON est re√ßu sous forme de `Map`, puis s√©rialis√© et sauvegard√© dans la colonne `data`.

```java
@Service
@Transactional
@Slf4j
public class OrDematService {

    private final DemandeOrRepository demandeOrRepository;
    private final ObjectMapper objectMapper;

    public OrDematService(DemandeOrRepository demandeOrRepository, ObjectMapper objectMapper) {
        this.demandeOrRepository = demandeOrRepository;
        this.objectMapper = objectMapper;
    }

    public DemandeOr createDemandeOr(Map<String, Object> payload) {
        log.info("üì© Cr√©ation d‚Äôune demande OR d√©finitif : {}", payload);

        try {
            DemandeOr demandeOr = new DemandeOr();
            demandeOr.setData(objectMapper.writeValueAsString(payload));
            return demandeOrRepository.save(demandeOr);
        } catch (JsonProcessingException e) {
            throw new RuntimeException("Erreur de conversion JSON", e);
        }
    }
}
```

---

### Contr√¥leur `OrDematResource.java`

Ajout d‚Äôun **endpoint POST `/api/or-definitif`** pour recevoir et sauvegarder une demande OR d√©finitif.

```java
@RestController
@RequestMapping("/api")
@Slf4j
public class OrDematResource {

    private final OrDematService orDematService;

    public OrDematResource(OrDematService orDematService) {
        this.orDematService = orDematService;
    }

    @PostMapping("/or-definitif")
    public ResponseEntity<DemandeOr> createDemandeOR(@RequestBody Map<String, Object> payload) {
        log.info("‚û°Ô∏è Requ√™te re√ßue pour cr√©ation d‚Äôun OR d√©finitif : {}", payload);

        DemandeOr result = orDematService.createDemandeOr(payload);
        return ResponseEntity.status(HttpStatus.CREATED).body(result);
    }
}
```

---

## R√©sultats attendus

* Endpoint **POST `/api/or-definitif`** cr√©√© et fonctionnel
* Les donn√©es JSON sont **persist√©es dans la table `demande_or`**
* Le champ `data` est bien typ√© **JSONB** en base PostgreSQL
* Le **Liquibase update** s‚Äôex√©cute sans erreur
* Le **JSON complet** est visible dans la colonne `data` apr√®s insertion

---

## Exemple d‚Äôappel API

**POST** `/api/or-definitif`

**Requ√™te :**

```json
{
  "typeOr": "DEFINITIF",
  "dateDebut": "2025-11-05T00:00:00Z",
  "dateFin": "2025-12-05T00:00:00Z",
  "adresseOrigine": "X",
  "adresseDestination": "X"
}
```

**R√©ponse (201 Created) :**

```json
{
  "id": 42,
  "data": "{\"typeOr\":\"DEFINITIF\",\"adresseDestination\":\"4 avenue du Port, Dumb√©a\", ...}"
}
```

---

## Structure Spring mise en place

| Couche         | Fichier principal          | R√¥le                                      |
| -------------- | -------------------------- | ----------------------------------------- |
| **Controller** | `OrDematResource.java`     | Exposition REST ‚Äî r√©ception du JSON       |
| **Service**    | `OrDematService.java`      | Logique m√©tier et s√©rialisation JSON      |
| **Repository** | `DemandeOrRepository.java` | Acc√®s JPA √† la table `demande_or`         |
| **Entity**     | `DemandeOr.java`           | Structure de persistance avec champ JSONB |

---

